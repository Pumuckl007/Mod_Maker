package modmaker.export;

import java.io.BufferedWriter;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.FileWriter;
import java.io.IOException;
import java.util.zip.ZipEntry;
import java.util.zip.ZipOutputStream;

import modmaker.Item;
import modmaker.Mod;
import modmaker.Start;

import com.google.gson.Gson;

public class Save {
	public static void save(Mod mod, File file){
		try{
			new File(Start.main.workingDir.getAbsolutePath() + "/temp/" + file.getName()).mkdirs();
			Gson gson = new Gson();
			StringBuilder builder = new StringBuilder();
			for(Item item : mod.items){
				builder.append(gson.toJson(item) + "\n");
			}
			BufferedWriter writer = new BufferedWriter(new FileWriter(Start.main.workingDir.getAbsolutePath() + "/temp/" + file.getName() + "/items.json"));
			writer.append(builder.toString());
			writer.close();
			ZipOutputStream out;
			if(file.getName().contains("."))
				out = new ZipOutputStream(new FileOutputStream(file.getAbsolutePath()));
			else
				out = new ZipOutputStream(new FileOutputStream(file.getAbsolutePath() + ".zip"));
			for(File f : new File(Start.main.workingDir.getAbsolutePath() + "/temp/" + file.getName() + "/").listFiles()){
				if(f.isDirectory()){
					FileUtils.writeSub(Start.main.workingDir.getAbsolutePath() + "/temp/" + file.getName() + "/", f, out);
				}
				else{
					FileInputStream in = new FileInputStream(f);
					System.out.println(f.getName());
					System.out.println(f.getAbsolutePath());

					out.putNextEntry(new ZipEntry(f.getAbsolutePath().replace(Start.main.workingDir.getAbsolutePath() + "/temp/" + file.getName() + "/", ""))); 

					byte[] b = new byte[1024];
					int count;

					while ((count = in.read(b)) > 0) {
						out.write(b, 0, count);
					}
					in.close();
				}
			}
			FileUtils.removeDirectory(new File(Start.main.workingDir.getAbsolutePath() + "/temp/" + file.getName()));
		}
		catch(Exception e){
			e.printStackTrace();
		}
	}
}
